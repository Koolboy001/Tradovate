<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tradovate - Transactions</title>
    <style>
         :root {
            --main-color: #00ffb7;
            --bg-dark: #0e0e0e;
            --bg-footer: #1e1e1e;
            --bg-light: #f4f4f4;
            --text-dark: #111111;
            /* dark text for light mode */
            --text-light: #fefefe;
            /* bright white text for dark mode */
            --subtle-light: #999;
            /* for minor text in light mode */
            --subtle-dark: #ccc;
            /* for minor text in dark mode */
        }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            background-color: var(--bg-dark);
            transition: background 0.3s ease, color 0.3s ease;
            padding-bottom: 70px;
        }
        
        header {
            background-color: #1e1e1e;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--main-color);
        }
        
        .language-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-footer);
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            border-top: 1px solid #333;
            z-index: 999;
        }
        
        .bottom-nav button {
            background: none;
            border: none;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            cursor: pointer;
        }
        
        .bottom-nav img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-bottom: 2px;
        }
        
        .theme-toggle {
            position: fixed;
            bottom: 75px;
            right: 15px;
            background-color: var(--main-color);
            color: #000;
            border: none;
            padding: 10px 14px;
            font-size: 12px;
            border-radius: 30px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 255, 183, 0.5);
            transition: background 0.3s;
        }
        /* Transaction Page Specific Styles */
        
        .transaction-toggle {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #333;
            position: relative;
        }
        
        .transaction-toggle button {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .transaction-toggle button.active {
            color: var(--main-color);
            border-bottom: 2px solid var(--main-color);
        }
        
        .position-button {
            position: absolute;
            right: 15px;
            top: 15px;
            background: rgba(0, 255, 183, 0.1);
            border: 1px solid var(--main-color);
            color: var(--main-color);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 183, 0.3);
        }
        
        .currency-selector {
            background: #111;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            margin: 15px;
        }
        
        .side-nav {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1001;
            transition: left 0.3s ease-out;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .side-nav.open {
            left: 0;
        }
        
        .side-nav h2 {
            color: var(--main-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .pair-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .pair-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pair-item:hover {
            background: rgba(0, 255, 183, 0.1);
        }
        
        .pair-item span:first-child {
            color: #ccc;
        }
        
        .pair-item span:last-child {
            font-weight: bold;
        }
        /* Trading View Chart Styles */
        
        .tradingview-widget-container {
            height: 100%;
            width: 100%;
        }
        
        .tradingview-widget-copyright {
            display: none;
        }
        
        #tradingview-chart {
            height: 300px;
            width: 100%;
            background: #111;
        }
        /* Rest of your existing styles... */
        
        .price-overview {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        .current-price {
            font-size: 28px;
            color: #00ffb7;
        }
        
        .price-change {
            color: #00ffb7;
        }
        
        .price-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .metric {
            font-size: 12px;
            color: #ccc;
        }
        
        .metric-value {
            font-size: 14px;
        }
        
        .chart-container {
            padding: 15px;
            height: 350px;
            margin: 15px;
            border-radius: 10px;
        }
        
        .timeframe-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .timeframe-selector button {
            background: #222;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .timeframe-selector button.active {
            background: var(--main-color);
            color: black;
        }
        
        .candle-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
            margin-top: 10px;
            color: #ccc;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            padding: 15px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .long-button {
            background: #00ffb7;
            color: black;
        }
        
        .short-button {
            background: #ff4d4d;
            color: white;
        }
        /* Exchange Tab Styles */
        
        .exchange-tab {
            padding: 15px;
            display: none;
        }
        
        .exchange-tab.active {
            display: block;
        }
        
        .buy-sell-tabs {
            display: flex;
            margin-bottom: 15px;
        }
        
        .buy-sell-tabs button {
            flex: 1;
            padding: 10px;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        
        .buy-tab {
            background: #0066ff;
            color: white;
            border-radius: 8px 0 0 8px;
        }
        
        .sell-tab {
            background: none;
            color: white;
            border: 1px solid #00ffb7;
            border-radius: 0 8px 8px 0;
        }
        
        .order-type {
            background: #111;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
        }
        
        .balance-info {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .best-price {
            font-size: 24px;
            color: #ff9900;
            margin: 15px 0;
            text-align: center;
        }
        
        .order-list {
            margin-bottom: 15px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .order-price {
            color: #ff4d4d;
        }
        
        .order-amount {
            color: #ccc;
        }
        
        .buy-button {
            width: 100%;
            padding: 15px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .transaction-history {
            padding: 15px;
            margin-top: 20px;
            border-top: 1px solid #333;
        }
        
        .history-tabs {
            display: flex;
            margin-bottom: 15px;
        }
        
        .history-tabs button {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .history-tabs button.active {
            color: var(--main-color);
            border-bottom: 2px solid var(--main-color);
        }
        
        .no-records {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }
        
        .no-records img {
            width: 100px;
            opacity: 0.5;
            margin-bottom: 15px;
        }
        /* Light Mode Styles */
        
        body.light-mode {
            color: var(--text-dark);
            background-color: var(--bg-light);
        }
        
        body.light-mode header,
        body.light-mode .bottom-nav,
        body.light-mode .side-nav,
        body.light-mode .chart-container,
        body.light-mode .order-type,
        body.light-mode .input-group input {
            background-color: #ffffff !important;
            color: #111111 !important;
        }
        
        body.light-mode .transaction-toggle button,
        body.light-mode .history-tabs button {
            color: #000;
        }
        
        body.light-mode .current-price,
        body.light-mode .price-change {
            color: #0066ff;
        }
        
        body.light-mode .metric {
            color: #666;
        }
        
        body.light-mode .action-buttons button,
        body.light-mode .buy-button {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .order-item {
            border-bottom: 1px solid #eee;
        }
        /* Overlay for when side nav is open */
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        /* Add this to your existing styles */
        
        .price-flash {
            animation: priceFlash 0.5s ease-in-out;
        }
        
        @keyframes priceFlash {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .current-price,
        .best-price {
            transition: color 0.3s ease;
        }
        /* Prevent horizontal scrolling and wiggling */
        
        html,
        body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }
        /* Optional: Add subtle overscroll behavior for iOS */
        
        body {
            overscroll-behavior-x: none;
        }
        /* Ensure all elements stay within viewport */
        
        * {
            max-width: 100%;
            box-sizing: border-box;
        }
        /* Optional: Add this if you have any absolutely positioned elements */
        
        .container {
            width: 100vw;
            overflow: hidden;
        }
    </style>
    <!-- TradingView Lightweight Chart script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>

<body>
    <header>
        <div class="logo"><img src="/assets/icons/logo.png" width="30px" alt=""></div>
        <a href="language.html"><img src="/assets/icons/worlwide.png" class="language-icon" alt="Language"></a>
    </header>

    <!-- Overlay for side nav -->
    <div class="overlay" id="overlay"></div>

    <div class="transaction-toggle">
        <button class="active" id="tradingTab">Trading</button>
        <button id="exchangeTab">Exchange</button><br><br>
        <button class="position-button" onclick="window.location.href='position.html'">
            <!-- Position -->
            <img src="/assets/icons/database.png" width="16" alt="">
        </button>
    </div>

    <button class="currency-selector" id="currencySelector">
        BTC
        <img src="/assets/icons/menu.png" width="16" alt="">
    </button>

    <!-- Side Navigation - Completely hidden until clicked -->
    <div class="side-nav" id="sideNav">
        <h2>Trading Pairs</h2>
        <div class="pair-list">
            <div class="pair-item">
                <span>BTC/USDT</span>
                <span>68,542.10</span>
            </div>
            <div class="pair-item">
                <span>ETH/USDT</span>
                <span>3,542.30</span>
            </div>
            <div class="pair-item">
                <span>SOL/USDT</span>
                <span>145.25</span>
            </div>
            <div class="pair-item">
                <span>XRP/USDT</span>
                <span>0.59</span>
            </div>
            <div class="pair-item">
                <span>ADA/USDT</span>
                <span>0.39</span>
            </div>
            <div class="pair-item">
                <span>DOGE/USDT</span>
                <span>0.084</span>
            </div>
            <div class="pair-item">
                <span>BNB/USDT</span>
                <span>560.25</span>
            </div>
            <div class="pair-item">
                <span>DOT/USDT</span>
                <span>6.42</span>
            </div>
            <div class="pair-item">
                <span>AVAX/USDT</span>
                <span>34.10</span>
            </div>
            <div class="pair-item">
                <span>LINK/USDT</span>
                <span>18.25</span>
            </div>
            <div class="pair-item">
                <span>MATIC/USDT</span>
                <span>0.75</span>
            </div>
            <div class="pair-item">
                <span>ATOM/USDT</span>
                <span>9.85</span>
            </div>
            <div class="pair-item">
                <span>FIL/USDT</span>
                <span>5.60</span>
            </div>
            <div class="pair-item">
                <span>LTC/USDT</span>
                <span>95.30</span>
            </div>
            <div class="pair-item">
                <span>UNI/USDT</span>
                <span>7.25</span>
            </div>
        </div>
    </div>

    <!-- Trading Tab Content -->
    <div id="tradingContent">
        <div class="price-overview">
            <div>
                <div>Current</div>
                <div class="current-price">105540.0100</div>
                <div class="price-change">+0.11%</div>
            </div>
            <div class="price-metrics">
                <div class="metric">
                    <div>H (High)</div>
                    <div class="metric-value">105934.00</div>
                </div>
                <div class="metric">
                    <div>L (Low)</div>
                    <div class="metric-value">105310.00</div>
                </div>
                <div class="metric">
                    <div>Opening</div>
                    <div class="metric-value">105612.36</div>
                </div>
                <div class="metric">
                    <div>24H Vol</div>
                    <div class="metric-value">58.48</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="timeframe-selector">
                <button class="active">1min</button>
                <button>5min</button>
                <button>15min</button>
                <button>30min</button>
                <button>1hour</button>
                <button>4hour</button>
                <button>1day</button>
                <button>1week</button>
                <button>1mon</button>
            </div>

            <!-- TradingView Chart Widget -->
            <div id="tradingview-chart"></div>

            <div class="candle-info" style="color: #00ffb7;">
                <div>Open: 105612.3600</div>
                <div>High: 105621.8600</div>
                <div>Low: 105539.9600</div>
                <div>Close: 105540.0100</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="long-button">Long</button>
            <button class="short-button">Short</button>
        </div>
    </div>

    <!-- Exchange Tab Content -->
    <div class="exchange-tab" id="exchangeContent">
        <div class="buy-sell-tabs">
            <button class="buy-tab">BUY</button>
            <button class="sell-tab">SELL</button>
        </div>

        <button class="order-type">Market</button>

        <div class="input-group">
            <label>Price (USDT)</label>
            <input type="text" placeholder="Optimal market price">
        </div>

        <div class="input-group">
            <label>Amount (BTC)</label>
            <input type="text" placeholder="0.00">
        </div>

        <div class="balance-info">Balance: 140.1266 USDT</div>

        <div class="best-price">105540.0000</div>

        <div class="order-list">
            <div class="order-item">
                <span class="order-price">105539.9600</span>
                <span class="order-amount">85.42</span>
            </div>
            <div class="order-item">
                <span class="order-price">105539.9500</span>
                <span class="order-amount">0.05</span>
            </div>
            <div class="order-item">
                <span class="order-price">105539.9400</span>
                <span class="order-amount">0.10</span>
            </div>
            <div class="order-item">
                <span class="order-price">105539.8500</span>
                <span class="order-amount">0.10</span>
            </div>
            <div class="order-item">
                <span class="order-price">105539.8300</span>
                <span class="order-amount">0.05</span>
            </div>
        </div>

        <button class="buy-button">BUY BTC</button>
    </div>

    <div class="transaction-history">
        <div class="history-tabs">
            <button class="active">Trading</button>
            <button>Exchange</button>
        </div>
        <div class="no-records">
            <img src="/assets/icons/no-record.png" alt="No records">
            <div style="color: #00ffb7;">No record</div>
        </div>
    </div>

    <div class="bottom-nav">
        <button onclick="window.location.href='index.html'">
            <img src="/assets/icons/home.png" alt="Home">
            Home
        </button>
        <button onclick="window.location.href='market.html'">
            <img src="/assets/icons/bull-market.png" alt="Market">
            Market
        </button>
        <button onclick="window.location.href='transactions.html'">
            <img src="/assets/icons/invoice.png" alt="Transactions">
            Transact
        </button>
        <button onclick="window.location.href='balance.html'">
            <img src="/assets/icons/money.png" alt="Balance">
            Balance
        </button>
        <button onclick="window.location.href='profile.html'">
            <img src="/assets/icons/user.png" alt="Profile">
            Profile
        </button>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">☀️</button>

    <script>
        // Theme toggle (keep your existing theme code)
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            if (window.tvWidget) {
                window.tvWidget.changeTheme(document.body.classList.contains('light-mode') ? 'light' : 'dark');
            }
        }

        // Auto-load theme (keep your existing code)
        (function() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
            }
        })();

        // Current selected pair (default to BTC/USDT)
        let currentPair = 'BTC/USDT';
        let currentSymbol = 'BTCUSDT';
        let currentPrice = 0;
        let previousPrice = 0;
        let priceChange24h = 0;
        let priceHigh24h = 0;
        let priceLow24h = 0;
        let volume24h = 0;
        let binanceSocket = null;
        let priceUpdateInterval = null;

        // Binance API mappings
        const binanceSymbols = {
            'BTC/USDT': 'BTCUSDT',
            'ETH/USDT': 'ETHUSDT',
            'SOL/USDT': 'SOLUSDT',
            'XRP/USDT': 'XRPUSDT',
            'ADA/USDT': 'ADAUSDT',
            'DOGE/USDT': 'DOGEUSDT',
            'BNB/USDT': 'BNBUSDT',
            'DOT/USDT': 'DOTUSDT',
            'AVAX/USDT': 'AVAXUSDT',
            'LINK/USDT': 'LINKUSDT',
            'MATIC/USDT': 'MATICUSDT',
            'ATOM/USDT': 'ATOMUSDT',
            'FIL/USDT': 'FILUSDT',
            'LTC/USDT': 'LTCUSDT',
            'UNI/USDT': 'UNIUSDT'
        };

        // Tab switching functionality (keep your existing code)
        const tradingTab = document.getElementById('tradingTab');
        const exchangeTab = document.getElementById('exchangeTab');
        const tradingContent = document.getElementById('tradingContent');
        const exchangeContent = document.getElementById('exchangeContent');

        tradingTab.addEventListener('click', () => {
            tradingTab.classList.add('active');
            exchangeTab.classList.remove('active');
            tradingContent.style.display = 'block';
            exchangeContent.classList.remove('active');
        });

        exchangeTab.addEventListener('click', () => {
            exchangeTab.classList.add('active');
            tradingTab.classList.remove('active');
            tradingContent.style.display = 'none';
            exchangeContent.classList.add('active');
        });

        // Side nav toggle with overlay (keep your existing code)
        const currencySelector = document.getElementById('currencySelector');
        const sideNav = document.getElementById('sideNav');
        const overlay = document.getElementById('overlay');

        currencySelector.addEventListener('click', (e) => {
            e.stopPropagation();
            sideNav.classList.toggle('open');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sideNav.classList.remove('open');
            overlay.classList.remove('active');
        });

        // Close side nav when clicking outside (keep your existing code)
        document.addEventListener('click', (e) => {
            if (!sideNav.contains(e.target) && e.target !== currencySelector) {
                sideNav.classList.remove('open');
                overlay.classList.remove('active');
            }
        });

        // Fetch real-time market data from Binance API
        async function fetchMarketData() {
            try {
                // Get 24hr ticker data
                const tickerResponse = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentSymbol}`);
                const tickerData = await tickerResponse.json();

                // Get current order book price
                const bookResponse = await fetch(`https://api.binance.com/api/v3/ticker/bookTicker?symbol=${currentSymbol}`);
                const bookData = await bookResponse.json();

                previousPrice = currentPrice;
                currentPrice = parseFloat(bookData.bidPrice);
                priceChange24h = parseFloat(tickerData.priceChangePercent);
                priceHigh24h = parseFloat(tickerData.highPrice);
                priceLow24h = parseFloat(tickerData.lowPrice);
                volume24h = parseFloat(tickerData.volume);

                updatePriceDisplay();
                updateSidebarPrices();
            } catch (error) {
                console.error('Binance API error:', error);
                await fetchCoinGeckoData();
            }
        }

        // Fallback to CoinGecko API
        async function fetchCoinGeckoData() {
            try {
                const coinGeckoIds = {
                    'BTC/USDT': 'bitcoin',
                    'ETH/USDT': 'ethereum',
                    'SOL/USDT': 'solana',
                    'XRP/USDT': 'ripple',
                    'ADA/USDT': 'cardano',
                    'DOGE/USDT': 'dogecoin',
                    'BNB/USDT': 'binancecoin',
                    'DOT/USDT': 'polkadot',
                    'AVAX/USDT': 'avalanche-2',
                    'LINK/USDT': 'chainlink',
                    'MATIC/USDT': 'matic-network',
                    'ATOM/USDT': 'cosmos',
                    'FIL/USDT': 'filecoin',
                    'LTC/USDT': 'litecoin',
                    'UNI/USDT': 'uniswap'
                };

                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinGeckoIds[currentPair]}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`);
                const data = await response.json();

                previousPrice = currentPrice;
                currentPrice = data.market_data.current_price.usd;
                priceChange24h = data.market_data.price_change_percentage_24h;
                priceHigh24h = data.market_data.high_24h.usd;
                priceLow24h = data.market_data.low_24h.usd;
                volume24h = data.market_data.total_volume.usd;

                updatePriceDisplay();
                updateSidebarPrices();
            } catch (error) {
                console.error('CoinGecko fallback failed:', error);
            }
        }

        // Update all price displays with color coding
        function updatePriceDisplay() {
            const formatPrice = (price) => {
                return price >= 1 ? price.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 6
                    }) :
                    price.toLocaleString(undefined, {
                        minimumFractionDigits: 6,
                        maximumFractionDigits: 6
                    });
            };

            const currentPriceElement = document.querySelector('.current-price');
            const bestPriceElement = document.querySelector('.best-price');

            // Update prices with color animation
            if (currentPrice > previousPrice) {
                currentPriceElement.style.color = '#00ffb7';
                bestPriceElement.style.color = '#00ffb7';
                flashElement(currentPriceElement);
                flashElement(bestPriceElement);
            } else if (currentPrice < previousPrice) {
                currentPriceElement.style.color = '#ff4d4d';
                bestPriceElement.style.color = '#ff4d4d';
                flashElement(currentPriceElement);
                flashElement(bestPriceElement);
            }

            currentPriceElement.textContent = formatPrice(currentPrice);
            bestPriceElement.textContent = formatPrice(currentPrice);

            // Update percentage change
            const changeElement = document.querySelector('.price-change');
            changeElement.textContent = `${priceChange24h > 0 ? '+' : ''}${priceChange24h.toFixed(2)}%`;
            changeElement.style.color = priceChange24h >= 0 ? '#00ffb7' : '#ff4d4d';

            // Update all metric values
            const metrics = [
                formatPrice(priceHigh24h), // High
                formatPrice(priceLow24h), // Low
                formatPrice(currentPrice / (1 + (priceChange24h / 100))), // Open
                formatVolume(volume24h) // Volume
            ];

            document.querySelectorAll('.metric-value').forEach((el, i) => {
                el.textContent = metrics[i];
            });

            // Update candle info
            const candleInfo = [
                `Open: ${formatPrice(currentPrice / (1 + (priceChange24h/100)))}`,
                `High: ${formatPrice(priceHigh24h)}`,
                `Low: ${formatPrice(priceLow24h)}`,
                `Close: ${formatPrice(currentPrice)}`
            ];

            document.querySelectorAll('.candle-info div').forEach((el, i) => {
                el.textContent = candleInfo[i];
            });
        }

        // Flash animation for price changes
        function flashElement(element) {
            element.classList.add('price-flash');
            setTimeout(() => {
                element.classList.remove('price-flash');
            }, 500);
        }

        // Update sidebar prices
        function updateSidebarPrices() {
            document.querySelectorAll('.pair-item').forEach(item => {
                const pair = item.querySelector('span:first-child').textContent;
                if (pair === currentPair) {
                    const priceElement = item.querySelector('span:last-child');
                    const newPrice = currentPrice.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 6
                    });

                    // Only update and animate if price changed
                    if (priceElement.textContent !== newPrice) {
                        const oldPrice = parseFloat(priceElement.textContent.replace(/,/g, ''));
                        if (!isNaN(oldPrice)) {
                            priceElement.style.color = currentPrice > oldPrice ? '#00ffb7' : '#ff4d4d';
                            flashElement(priceElement);
                        }
                        priceElement.textContent = newPrice;
                    }
                }
            });
        }

        // Format large volume numbers
        function formatVolume(volume) {
            if (volume >= 1000000000) {
                return `${(volume / 1000000000).toFixed(2)}B`;
            } else if (volume >= 1000000) {
                return `${(volume / 1000000).toFixed(2)}M`;
            } else if (volume >= 1000) {
                return `${(volume / 1000).toFixed(2)}K`;
            }
            return volume.toFixed(2);
        }

        // Initialize WebSocket for real-time updates
        function initializeWebSocket() {
            if (binanceSocket) {
                binanceSocket.close();
            }

            binanceSocket = new WebSocket(`wss://stream.binance.com:9443/ws/${currentSymbol.toLowerCase()}@ticker`);

            binanceSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                previousPrice = currentPrice;
                currentPrice = parseFloat(data.c);
                priceChange24h = parseFloat(data.P);
                priceHigh24h = parseFloat(data.h);
                priceLow24h = parseFloat(data.l);
                volume24h = parseFloat(data.v);

                updatePriceDisplay();
                updateSidebarPrices();
            };

            binanceSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                // Fallback to API polling
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = setInterval(fetchMarketData, 2000);
            };
        }

        // Initialize TradingView Widget with proper timeframe handling
        function initializeTradingViewChart(interval = '1') {
            if (window.tvWidget) {
                window.tvWidget.remove();
            }

            const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';

            window.tvWidget = new TradingView.widget({
                "autosize": true,
                "symbol": `BINANCE:${currentSymbol}`,
                "interval": interval,
                "timezone": "Etc/UTC",
                "theme": theme,
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#0e0e0e",
                "enable_publishing": false,
                "hide_top_toolbar": true,
                "hide_side_toolbar": true,
                "allow_symbol_change": false,
                "container_id": "tradingview-chart",
                "studies": ["MAExp@tv-basicstudies"],
                "disabled_features": [
                    "header_widget", "left_toolbar", "timeframes_toolbar",
                    "edit_buttons_in_legend", "context_menus", "control_bar",
                    "border_around_the_chart", "header_settings", "header_chart_type",
                    "header_compare", "header_undo_redo", "header_screenshot",
                    "header_fullscreen_button"
                ]
            });
        }

        // Pair selection handler
        document.querySelectorAll('.pair-item').forEach(item => {
            item.addEventListener('click', function() {
                currentPair = this.querySelector('span:first-child').textContent;
                currentSymbol = binanceSymbols[currentPair];

                // Update UI
                currencySelector.innerHTML = `${currentPair.split('/')[0]} <img src="/assets/icons/menu.png" width="16" alt="">`;

                // Close side nav
                sideNav.classList.remove('open');
                overlay.classList.remove('active');

                // Refresh data
                fetchMarketData();
                initializeWebSocket();

                // Reinitialize chart with current timeframe
                const activeTimeframe = document.querySelector('.timeframe-selector button.active');
                if (activeTimeframe) {
                    const intervals = {
                        '1min': '1',
                        '5min': '5',
                        '15min': '15',
                        '30min': '30',
                        '1hour': '60',
                        '4hour': '240',
                        '1day': 'D',
                        '1week': 'W',
                        '1mon': 'M'
                    };
                    initializeTradingViewChart(intervals[activeTimeframe.textContent]);
                } else {
                    initializeTradingViewChart();
                }
            });
        });

        // Timeframe selector functionality with proper chart updates
        const timeframeButtons = document.querySelectorAll('.timeframe-selector button');
        timeframeButtons.forEach(button => {
            button.addEventListener('click', () => {
                timeframeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const intervals = {
                    '1min': '1',
                    '5min': '5',
                    '15min': '15',
                    '30min': '30',
                    '1hour': '60',
                    '4hour': '240',
                    '1day': 'D',
                    '1week': 'W',
                    '1mon': 'M'
                };

                if (window.tvWidget) {
                    window.tvWidget.setInterval(intervals[button.textContent]);
                } else {
                    initializeTradingViewChart(intervals[button.textContent]);
                }
            });
        });

        // Simulate order book updates
        function simulateOrderBookUpdates() {
            const orderList = document.querySelector('.order-list');

            function updateOrders() {
                const basePrice = currentPrice;
                orderList.innerHTML = '';

                for (let i = 0; i < 5; i++) {
                    const price = (basePrice - (i * 0.01) - Math.random() * 0.1).toFixed(4);
                    const amount = (Math.random() * 100).toFixed(2);

                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                    <span class="order-price">${price}</span>
                    <span class="order-amount">${amount}</span>
                `;
                    orderList.appendChild(orderItem);
                }
            }

            updateOrders();
            setInterval(updateOrders, 5000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchMarketData();
            initializeWebSocket();
            initializeTradingViewChart();
            simulateOrderBookUpdates();

            // Backup polling in case WebSocket fails
            priceUpdateInterval = setInterval(fetchMarketData, 30000);
        });
    </script>


</body>

</html>